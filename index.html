<!DOCTYPE HTML>
<html>
  <head>
	<title>Memory</title>	
	<style>
		#tavolo {
			display: grid;
			grid-template-columns: 100px 100px 100px 100px 100px;
			grid-gap: 10px;
			background-color: #fff; /*coore binco*/
			/*background-color: white;*/ /*coore binco*/
		}
	
	</style>
  </head>
  
  <body>
	<h1>Memory Game</h1>
	
	<div id="tavolo">
	    <!--img src="images/whale.png"-->
	</div>	

	<script>

        class Carta {
            constructor(name, img){  //metodo costruttore
                this.name = name; //nome carta
                this.img = img; //il percorso e il nome del file immagine associata alla carta
                this.posizione = -1; //della carta sul tavolo da gioco (valori 0...19, e -1 se viene tolta dal tavolo
                this.girata = false; // TRUE quando mostra l'immagine relativa
            } 
            giraCarta() { //cambia il valore dell'attributo girata da TRUE a FALSE e

                this.girata = ! this.girata;
            } 
            posizionaCarta(pos) {
                this.posizione = pos;
            }
            rimuoviCarta() {
                this.posizione = -1;
            }

        }

class Mazzo {
	// carte
    // la sequenza di carte che verranno posizionate sul tavolo da gioco 
    constructor() {
        this.carte = [
            new Carta('whale','images/whale.png'),
            new Carta('seeHorse','images/seeHorse.png'),
            new Carta('seeStar','images/seeStar.png'),
            new Carta('seeShell','images/seeShell.png'),
            new Carta('stingRay','images/stingRay.png'),
            new Carta('shark','images/shark.png'),
            new Carta('ballFish','images/ballFish.png'),
            new Carta('delphin','images/delphin.png'),
            new Carta('crab','images/crab.png'),
            new Carta('turtle','images/turtle.png'),
            new Carta('whale','images/whale.png'),
            new Carta('seeHorse','images/seeHorse.png'),
            new Carta('seeStar','images/seeStar.png'),
            new Carta('seeShell','images/seeShell.png'),
            new Carta('stingRay','images/stingRay.png'),
            new Carta('shark','images/shark.png'),
            new Carta('ballFish','images/ballFish.png'),
            new Carta('delphin','images/delphin.png'),
            new Carta('crab','images/crab.png'),
            new Carta('turtle','images/turtle.png')
        ];
        this.mischia()
    }
  
    //mischia le carte
    mischia() {

	    //pi: posizione iniziale
	    //pr: posizione randomica
	    for(let pi = 0; pi < this.carte.length; pi++) {
	    	let pr = Math.floor (Math.random()*19);
	    	[this.carte[pi], this.carte[pr]] = [this.carte[pr], this.carte[pi]];
    
        }
        
    }
}

class Memory {

    constructor() {

        self = this;  // definisco variabile "self" per quando "this" perde il suo contesto

        //la variabile tavolo contiene il rferimento alla sezione nel documento chiamata "tavolo"
        this.tavolo = document.querySelector('#tavolo');
        this.carteArray = new Mazzo().carte;	
        console.log (this.carteArray);

        this.posizionaCarte();
        this.carteScelte  = []; // il nome e la posizione delle carte scelte

    }
	
	posizionaCarte() {

	    for (let posizione = 0; posizione < this.carteArray.length; posizione++) {
	    	// creo un posto nel documento HTML per una carta
	    	var carta = document.createElement('img');

	    	// inizialmente la carta e' girata e quindi non mostra la figura
	    	carta.setAttribute('src', "images/blank.png");
	    	carta.setAttribute('carta-numero', posizione);
	    	carta.setAttribute('nome', this.carteArray[posizione].name);
	    	// aggiungo alla carta la possibilita' di poter essere scoperta/girata
	    	// cliccando sulla carta eseguiro' una funzione che la scopre
	    	carta.addEventListener('click', this.scopriCarta);

        
	    	//aggiungo la carta sul tavolo
	    	tavolo.appendChild(carta);
	    }
    }
	

	//scopri la carta selezionata sul tavolo
    scopriCarta() {
        //la funzione è chiamata dall'elemento(carta) che è stato cliccato
        //this è l'elemento del DOM
		let nome = this.getAttribute('nome');
        let posizione = this.getAttribute('carta-numero');

        //per accedere alle funzioni e attributi dell'oggetto ricorriamo a self
        //visto che this non è l'oggetto ma l'elemento del documento cliccato...
        console.log(nome+" ... "+posizione+" ... "+self.carteArray[posizione].img);
		this.setAttribute('src', self.carteArray[posizione].img);
		// notate che alla posizione della carta sul tavolo corrisponde la carta nell'Array di carteArray
		if(self.carteScelte.length == 1 && self.carteScelte[0].pos == posizione) return false;
		self.carteScelte.push({nome: nome, pos: posizione});
		console.log(self.carteScelte);
		if(self.carteScelte.length == 2) setTimeout(self.controllaCarte, 333);
	}
	
	controllaCarte() { //FIXME
		let carte = document.querySelectorAll('img'); //restituisce un array di riferimenti agli elemti <img> nella pagina web
		if(self.carteScelte[0].nome == self.carteScelte[1].nome) { //carte scelte coincidono
			alert("Bravo, hai indovinato");
			//rimuovi le carte dal tavolo
			carte[self.carteScelte[0].pos].setAttribute('src', 'images/vuota.png');
			carte[self.carteScelte[1].pos].setAttribute('src', 'images/vuota.png');

		} else {
			alert("Booo! Prova di nuovo sarai piu' fortunato");
			// sostituisco l'immagine della carta con l'immagine della carte girata
			carte[self.carteScelte[0].pos].setAttribute('src', 'images/blank.png');
			carte[self.carteScelte[1].pos].setAttribute('src', 'images/blank.png');
		}
		// in entrambi i casi svuoto l'array delle carte scelte per il nuovo turno di gioco
		self.carteScelte  = [];
    }
}

	//questo è uno programma in Javascript
	//DOM Document Object Model (rappresentazione interna al Browser della pagina HTML ricevuta)
	//l'evento "DOMContentLoaded" viene generato una volta che il documento è stato ricevuto, e tradotto nella sua rappresentazione interna (DOM)
	// tutte le istruzioni allinterno delle {} verrà eseguita DOPO aver ricevuto l'evento
document.addEventListener('DOMContentLoaded', () => {
    let memory = new Memory();
    console.log(memory);
});
	</script>
  
  </body>
</html>
